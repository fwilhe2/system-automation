# SPDX-FileCopyrightText: Florian Wilhelm
# SPDX-License-Identifier: MIT

---
- name: Install Virtualization Packages
  become: true
  become_user: root
  package:
    state: present
    name: "{{ item }}"
  loop:
    - libvirt-daemon
    - libvirt-daemon-system
    - qemu-system
    - vagrant
    - vagrant-libvirt
    - virtinst

- name: Set the domain socket group ownership to libvirt
  ansible.builtin.lineinfile:
    path: /etc/libvirt/libvirtd.conf
    regexp: '^#unix_sock_group = "libvirt"'
    line: 'unix_sock_group = "libvirt"'
  become: true

- name: Adjust the UNIX socket permissions for the R/W socket
  ansible.builtin.lineinfile:
    path: /etc/libvirt/libvirtd.conf
    regexp: '^#unix_sock_rw_perms = "0770"'
    line: 'unix_sock_rw_perms = "0770"'
  become: true

- name: Start and enable the libvirtd service
  ansible.builtin.systemd:
    name: libvirtd
    state: started
    enabled: yes
  become: true

- name: Add user to group
  ansible.builtin.user:
    name: "{{ username }}"
    groups: libvirt
    append: yes
  become: true
